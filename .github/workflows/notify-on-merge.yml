name: PR Merge AI Summary Notification via Copilot

on:
  pull_request:
    types: [closed]
    branches: [main]
  push:
    branches: ["main"]

jobs:
  send_email:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y gh

      # Install Copilot CLI if available - fallback to models if not
      - name: Attempt Copilot CLI Install
        continue-on-error: true
        run: |
          # Try to install Copilot CLI. Available if Copilot for CLI is enabled for your repo.
          npm install -g @githubnext/github-copilot-cli || true

      - name: Generate Copilot PR Summary
        id: ai_summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh extension install github/gh-models
          # Get the diff
          gh pr diff $PR_NUMBER --patch > pr_diff.txt
          
          # NEW PROMPT: Focused on file-level changes
          PROMPT="Act as a technical lead. Analyze this PR diff and provide:
          1. A high-level summary of the goal.
          2. A file-by-file breakdown. For each file, list what was added, removed, or changed and WHY.
          3. Use markdown bolding for filenames.
          
          DIFF:
          $(cat pr_diff.txt | head -n 200)" # Sending first 200 lines for context
          
          gh models generate --model openai/gpt-4o --prompt "$PROMPT" > pr_summary.txt

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # Send Email with Copilot Summary and PR Diff
      - name: Send Summary Email via Python
        env:
          # --- Email Secrets ---
          EMAIL_SERVER: ${{ secrets.EMAIL_SERVER }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          # --- PR Metadata ---
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_MERGED_BY: ${{ github.event.pull_request.merged_by.login }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        # Pass the filenames as arguments to the script  
        run: python .github/scripts/send_email.py pr_summary.txt pr_diff.txt
