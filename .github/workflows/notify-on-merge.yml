name: PR Merge Email Connection Test

on:
  pull_request:
    # Trigger on PR close (we will test by merging a PR)
    types: [closed]
    branches: [main]

jobs:
  send_email_test:
    runs-on: ubuntu-latest
    # Only run if the PR was actually merged
    if: github.event.pull_request.merged == true
    
    # We only need permissions to read content (to checkout the repo)
    permissions:
      contents: read
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # The simplified step to test the SMTP connection and secrets
      - name: Test Email Connection via Python
        env:
          # --- EMAIL SECRETS ---
          EMAIL_SERVER: ${{ secrets.EMAIL_SERVER }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          # --- TEST CONTENT ---
          EMAIL_TO: 'de_jaipur@gmail.com'
          EMAIL_SUBJECT: "âœ… GITHUB ACTION TEST: PR ${{ github.event.pull_request.number }} Merged Successfully"
          EMAIL_BODY: |
            A Pull Request was merged to main. This email confirms that the GitHub Actions workflow successfully authenticated and connected to your SMTP server (using the secrets you provided) and sent this notification.
            
            PR Title: ${{ github.event.pull_request.title }}
            Action Status: SUCCESS
            
        run: |
          python - <<EOF
          import smtplib
          from email.mime.text import MIMEText
          import os
          import sys

          # Fetch environment variables
          sender = os.environ['EMAIL_USERNAME']
          receiver = os.environ['EMAIL_TO']
          subject = os.environ['EMAIL_SUBJECT']
          body = os.environ['EMAIL_BODY']
          
          # Create message object (plain text for simplicity)
          msg = MIMEText(body, 'plain')
          msg['Subject'] = subject
          msg['From'] = sender
          msg['To'] = receiver

          print(f"Attempting connection to {os.environ['EMAIL_SERVER']} on port {os.environ['EMAIL_PORT']}...")
          
          try:
              # 1. Connect and Start TLS
              server = smtplib.SMTP(os.environ['EMAIL_SERVER'], int(os.environ['EMAIL_PORT']))
              server.starttls()
              
              # 2. Login using secrets
              server.login(os.environ['EMAIL_USERNAME'], os.environ['EMAIL_PASSWORD'])
              print("Authentication successful.")
              
              # 3. Send email
              server.sendmail(sender, [receiver], msg.as_string())
              print("SUCCESS: Test email sent.")
              
          except Exception as e:
              print(f"FAILURE: Could not send email. Check secrets and firewall settings. Error: {e}")
              sys.exit(1) # Fail the workflow step
              
          finally:
              server.quit()
          EOF